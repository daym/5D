#!/usr/bin/env python

import sys

def parseAux(name): # gcc -aux-info
	result = {}
	with open(name, "r") as f:
		for line in f.readlines():
			if line.startswith("/*"):
				i = line.find("*/")
				assert(i != -1)
				line = line[i + 2 : ].lstrip()
				beforebrace = line.split("(")[0].strip()
				name = beforebrace.split(" ")[-1]
				line = line.replace("extern ", "")
				result[name] = line
	return(result)
mapping = {
		"void": "v",
		"BYTE": "i", # FIXME
		"CHAR": "i", # FIXME
		"char": "i", # FIXME
		"WCHAR": "i", # FIXME
		"UINT_PTR": "i", # FIXME
		"WPARAM": "i", # FIXME
		"SIZE_T": "l", # FIXME
		"LCID": "i", # FIXME
		"CALID": "i", # FIXME
		"COLORREF": "i",
		"WORD": "h",
		"INT": "i",
		"int": "i",
		"SHORT": "h",
		"DWORD": "i",
		"UINT": "i",
		"BOOL": "i",
		"HWND": "p",
		"HDC": "p",
		"HINSTANCE": "p",
		"HANDLE": "p",
		"HMENU": "p",
		"HDESK": "p",
		"HBITMAP": "p",
		"HICON": "p",
		"HRGN": "p",
		"HCURSOR": "p",
		"HBRUSH": "p",
		"HMONITOR": "p",
		"HCONV": "p",
		"HCONVLIST": "p",
		"HACCEL": "p",
		"HKL": "p", # keyboard layout
		"HFILE": "p", # FIXME
		"LONG": "l",
		"PICONINFO": "p",
		"PCURSORINFO": "p",
		"LRESULT": "l", # FIXME
		"LPCSTR": "s",
		"LPWSTR": "p",
		"LPCWSTR": "p",
		"LPSTR": "p",
		"ULONG_PTR": "P",
		"PVOID": "p",
		"PBYTE": "p",
		"PBOOL": "p",
		"PDWORD": "p",
		"PWINDOWINFO": "p",
		"long int": "l",
		"WNDPROC": "p",
		"DLGPROC": "p",
		"GRAYSTRINGPROC": "p",
		"TIMERPROC": "p",
		"HOOKPROC": "p",
		"PUINT_PTR": "p",
		"ATOM": "h",
		"HMODULE": "p",
		"ABORTPROC": "p",
		"ENHMFENUMPROC": "p",
		"FLOAT": "f",
		"FONTENUMPROCA": "p",
		"FONTENUMPROCW": "p",
		"GOBJENUMPROC": "p",
		"HCOLORSPACE": "p",
		"HENHMETAFILE": "p",
		"HFONT": "p",
		"HGDIOBJ": "p",
		"HGLOBAL": "p",
		"HMETAFILE": "p",
		"HPALETTE": "p",
		"HPEN": "p",
		"ICMENUMPROCA": "p",
		"ICMENUMPROCW": "p",
		"LINEDDAPROC": "p",
		"MFENUMPROC": "p",
		"PCVOID": "p",
		"PFLOAT": "p",
		"PLOGFONTA": "p",
		"PLOGFONTW": "p",
		"PHANDLE": "p",
		"CALID": "i",
		"CALTYPE": "i",
		"HLOCAL": "p",
		"ENUMRESLANGPROC": "p",
		"ENUMRESNAMEPROC": "p",
		"ENUMRESTYPEPROC": "p",
		"LONG_PTR": "l",
		"ULONG_PTR": "l",
		"LPCRITICAL_SECTION": "p",
		"DATEFMT_ENUMPROC": "p",
		"PULARGE_INTEGER": "p",
		"ULARGE_INTEGER": "L",
		"GEOID": "i", # FIXME
		"GEOTYPE": "i", # FIXME
		"LANGID": "h",
		"CODEPAGE_ENUMPROC": "p",
		"GEO_ENUMPROC": "p",
		"GEOCLASS": "i", # FIXME
		"CALINFO_ENUMPROC": "p",
		"LCTYPE": "i", # FIXME
		"GET_FILEEX_INFO_LEVELS": "i", # enum
		"FINDEX_INFO_LEVELS": "i", # enum
		"FINDEX_SEARCH_OPS": "i", # enum
		"LPOVERLAPPED": "p",
		"HRSRC": "p",
		"PULONG": "p",
		"PULONG_PTR": "p",
		"HSZ": "p",
		"PTITLEBARINFO": "p",
		"PSCROLLBARINFO": "p",
		"PLASTINPUTINFO": "p",
		"PCOMBOBOXINFO": "p",
		"PCONVINFO": "p",
		"PALTTABINFO": "p",
		"LPTSTR": "p", # FIXME
		"DEVMODE *": "p", # must be NULL
		"PLONG": "l",
		"PSMALL_RECT": "p",
		"HHOOK": "p",

		# generic:
		"enum": "i",
		"flags": "i",
		"callback": "p",
		"time_t": "i",
		"double": "d",
		"uint64": "L",
		"int64": "L",
		"unsigned int": "i",
		"long unsigned int": "l",
		
		# GTK
		"gint": "i",
		"guint": "i",
		"gpointer": "p",
		"gboolean": "i",
		"gchar": "i", # FIXME
		"u4": "i",
		"guint32": "u4",
		"GQuark": "guint32",
		"GType": "gsize",
		"gsize": "l", # FIXME
		"gssize": "l", # FIXME
		"gdouble": "d",
		"GtkToolPaletteDragTargets": "flags",
		"gchar **": "p",
		"GDestroyNotify": "callback",
		"GtkTranslateFunc": "callback",
		"GtkTreePath **": "p",
		"AppIndicatorCategory": "enum",
		"AppIndicatorStatus": "enum",
		"AtkRole": "enum",
		"AtkLayer": "enum",
		"AtkRelationType": "enum",
		"AtkStateType": "enum",
		"AtkTextAttribute": "enum",
		"AtkTextBoundary": "enum",
		"AtkKeyEventType": "enum",
		"AtkCoordType": "enum",
		"AtkTextClipType": "enum",
		"GdkCursorType": "enum",
		"GdkDragProtocol": "enum",
		"GdkFilterReturn": "enum",
		"GdkEventType": "enum",
		"GdkVisibilityState": "enum",
		"GdkScrollDirection": "enum",
		"GdkNotifyType": "enum",
		"GdkCrossingMode": "enum",
		"GdkPropertyState": "enum",
		"GdkSettingAction": "enum",
		"GdkFontType": "enum",
		"GdkCapStyle": "enum",
		"GdkFill": "enum",
		"GdkFunction": "enum",
		"GdkJoinStyle": "enum",
		"GdkLineStyle": "enum",
		"GdkSubwindowMode": "enum",
		"GdkImageType": "enum",
		"GdkExtensionMode": "enum",
		"GdkInputSource": "enum",
		"GdkInputMode": "enum",
		"GdkAxisUse": "enum",
		"GdkPropMode": "enum",
		"GdkFillRule": "enum",
		"GdkOverlapType": "enum",
		"GdkRgbDither": "enum",
		"GdkByteOrder": "enum",
		"GdkStatus": "enum",
		"GdkGrabStatus": "enum",
		"GdkVisualType": "enum",
		"GdkWindowClass": "enum",
		"GdkWindowType": "enum",
		"GdkWindowTypeHint": "enum",
		"GdkGravity": "enum",
		"GdkWindowEdge": "enum",
		"GdkPixbufAlphaMode": "enum",
		"GdkColorspace": "enum",
		"GdkPixbufError": "enum",
		"GdkPixbufRotation": "enum",
		"GdkInterpType": "enum",
		"GdkOwnerChange": "enum",
		"GtkAssistantPageType": "enum",
		"GtkCellRendererAccelMode": "enum",
		"GtkPageOrientation": "enum",
		"GtkPageSet": "enum",
		"GtkPrintDuplex": "enum",
		"GtkPrintError": "enum",
		"GtkPrintOperationAction": "enum",
		"GtkPrintOperationResult": "enum",
		"GtkPrintPages": "enum",
		"GtkPrintQuality": "enum",
		"GtkPrintStatus": "enum",
		"GtkRecentChooserError": "enum",
		"GtkRecentManagerError": "enum",
		"GtkRecentSortType": "enum",
		"GtkSensitivityType": "enum",
		"GtkTextBufferTargetInfo": "enum",
		"GtkTreeViewGridLines": "enum",
		"GtkUnit": "enum",
		"GtkBuilderError": "enum",
		"GtkNumberUpLayout": "enum",
		"GtkEntryIconPosition": "enum",
		"GtkAnchorType": "enum",
		"GtkArrowType": "enum",
		"GtkButtonBoxStyle": "enum",
		"GtkButtonsType": "enum",
		"GtkCellRendererMode": "enum",
		"GtkCellType": "enum",
		"GtkCListDragPos": "enum",
		"GtkCornerType": "enum",
		"GtkCTreeExpanderStyle": "enum",
		"GtkCTreeExpansionType": "enum",
		"GtkCTreeLineStyle": "enum",
		"GtkCTreePos": "enum",
		"GtkCurveType": "enum",
		"GtkDeleteType": "enum",
		"GtkDirectionType": "enum",
		"GtkExpanderStyle": "enum",
		"GtkFileChooserAction": "enum",
		"GtkFileChooserConfirmation": "enum",
		"GtkFileChooserError": "enum",
		"GtkIconSize": "enum",
		"GtkIconThemeError": "enum",
		"GtkIconViewDropPosition": "enum",
		"GtkImageType": "enum",
		"GtkIMPreeditStyle": "enum",
		"GtkIMStatusStyle": "enum",
		"GtkPackDirection": "enum",
		"GtkJustification": "enum",
		"GtkMatchType": "enum",
		"GtkMenuDirectionType": "enum",
		"GtkMessageType": "enum",
		"GtkMetricType": "enum",
		"GtkMovementStep": "enum",
		"GtkNotebookTab": "enum",
		"GtkOrientation": "enum",
		"GtkPackType": "enum",
		"GtkPathPriorityType": "enum",
		"GtkPathType": "enum",
		"GtkPolicyType": "enum",
		"GtkPositionType": "enum",
		"GtkPreviewType": "enum",
		"GtkProgressBarOrientation": "enum",
		"GtkProgressBarStyle": "enum",
		"GtkRcTokenType": "enum",
		"GtkReliefStyle": "enum",
		"GtkResizeMode": "enum",
		"GtkResponseType": "enum",
		"GtkScrollStep": "enum",
		"GtkScrollType": "enum",
		"GtkSelectionMode": "enum",
		"GtkShadowType": "enum",
		"GtkSideType": "enum",
		"GtkSignalRunType": "enum",
		"GtkSizeGroupMode": "enum",
		"GtkSortType": "enum",
		"GtkSpinButtonUpdatePolicy": "enum",
		"GtkSpinType": "enum",
		"GtkStateType": "enum",
		"GtkSubmenuDirection": "enum",
		"GtkSubmenuPlacement": "enum",
		"GtkTextDirection": "enum",
		"GtkTextWindowType": "enum",
		"GtkToolbarChildType": "enum",
		"GtkToolbarSpaceStyle": "enum",
		"GtkToolbarStyle": "enum",
		"GtkTreeViewColumnSizing": "enum",
		"GtkTreeViewDropPosition": "enum",
		"GtkTreeViewMode": "enum",
		"GtkUpdateType": "enum",
		"GtkVisibility": "enum",
		"GtkWidgetHelpType": "enum",
		"GtkWindowPosition": "enum",
		"GtkWindowType": "enum",
		"GtkWrapMode": "enum",
		"GtkFileSystemError": "enum",
		"GtkSourceSmartHomeEndType": "enum",
		"GtkSourceCompletionError": "enum",
		"IndicateInterests": "enum",
		"PangoAlignment": "enum",
		"PangoAttrType": "enum",
		"PangoCoverageLevel": "enum",
		"PangoDirection": "enum",
		"PangoEllipsizeMode": "enum",
		"PangoGravity": "enum",
		"PangoGravityHint": "enum",
		"PangoRenderPart": "enum",
		"PangoScript": "enum",
		"PangoStretch": "enum",
		"PangoStyle": "enum",
		"PangoTabAlign": "enum",
		"PangoUnderline": "enum",
		"PangoVariant": "enum",
		"PangoWeight": "enum",
		"PangoWrapMode": "enum",
		"NotifyUrgency": "enum",
		"GtkTreeModelForeachFunc": "callback",
		"AtkHyperlinkStateFlags": "flags",
		"GdkDragAction": "flags",
		"GdkEventMask": "flags",
		"GdkWindowState": "flags",
		"GdkGCValuesMask": "flags",
		"GdkModifierType": "flags",
		"GdkInputCondition": "flags",
		"GdkWindowAttributesType": "flags",
		"GdkWindowHints": "flags",
		"GdkWMDecoration": "flags",
		"GdkWMFunction": "flags",
		"GtkRecentFilterFlags": "flags",
		"GtkToolPaletteDragTargets": "flags",
		"GtkAccelFlags": "flags",
		"GtkArgFlags": "flags",
		"GtkAttachOptions": "flags",
		"GtkButtonAction": "flags",
		"GtkCalendarDisplayOptions": "flags",
		"GtkCellRendererState": "flags",
		"GtkDebugFlag": "flags",
		"GtkDestDefaults": "flags",
		"GtkDialogFlags": "flags",
		"GtkFileFilterFlags": "flags",
		"GtkIconLookupFlags": "flags",
		"GtkObjectFlags": "flags",
		"GtkPrivateFlags": "flags",
		"GtkRcFlags": "flags",
		"GtkTargetFlags": "flags",
		"GtkTextSearchFlags": "flags",
		"GtkTreeModelFlags": "flags",
		"GtkUIManagerItemType": "flags",
		"GtkWidgetFlags": "flags",
		"GtkFileInfoType": "flags",
		"GtkSourceSearchFlags": "flags",
		"GtkSourceDrawSpacesFlags": "flags",
		"GtkSourceCompletionActivation": "flags",
		"GtkPrintCapabilities": "flags",
		"PangoFontMask": "flags",
		"GtkAssistantPageFunc": "callback",
		"guint16": "h",
		"GError **": "p",
		"GtkTreeCellDataFunc": "callback",
		"GtkRecentSortFunc": "callback",
		"gfloat": "f",
		"GtkTreeModelFilterModifyFunc": "callback",
		"GtkTreeViewRowSeparatorFunc": "callback",
		"GtkClipboardURIReceivedFunc": "callback",
		"GdkAtom": "p",
		"glong": "l",
		"GIcon **": "p",
		"GtkTextCharPredicate": "callback",
		"GdkNativeWindow": "l", # FIXME
		"GtkClipboardTextReceivedFunc": "callback",
		"const gchar **": "p",
		"GtkAccelMapForeach": "callback",
		"GtkCellRenderer **": "p",
		"GtkCalendarDetailFunc": "callback",
		"GtkTreeSelectionForeachFunc": "callback",
		"GtkTreeViewSearchEqualFunc": "callback",
		"GdkColor **": "p",
		"GtkClipboardImageReceivedFunc": "callback",
		"GdkPoint **": "p",
		"gunichar": "guint32",
		"GtkEntryCompletionMatchFunc": "callback",
		"GtkPageSetupDoneFunc": "callback",
		"GtkCallback": "callback",
		"GtkColorSelectionChangePaletteWithScreenFunc": "callback",
		"GtkTreeModel **": "p",
		"GtkTextTagTableForeach": "callback",
		"GtkTreeSelectionFunc": "callback",
		"GtkTextBufferDeserializeFunc": "callback",
		"GtkClipboardReceivedFunc": "callback",
		"GCallback": "callback",
		"GList **": "p",
		"GCompareFunc": "callback",
		"GdkEventFunc": "callback",
		"GdkFilterFunc": "callback",
		"GladeXMLConnectFunc": "callback",
		"GtkAboutDialogActivateLinkFunc": "callback",
		"GtkBuilderConnectFunc": "callback",
		"GtkCalendarDetailFunc": "callback",
		"GtkCellLayoutDataFunc": "callback",
		"GtkColorSelectionChangePaletteFunc": "callback",
		"GtkColorSelectionChangePaletteWithScreenFunc": "callback",
		"GtkCTreeFunc": "callback",
		"GtkCTreeGNodeFunc": "callback",
		"GtkEntryCompletionMatchFunc": "callback",
		"GtkFileFilterFunc": "callback",
		"GtkIconViewForeachFunc": "callback",
		"GtkLinkButtonUriFunc": "callback",
		"GtkMenuPositionFunc": "callback",
		"GtkNotebookWindowCreationFunc": "callback",
		"GtkPrinterFunc": "callback",
		"GtkPrintSettingsFunc": "callback",
		"GtkRecentFilterFunc": "callback",
		"GtkSignalFunc": "callback",
		"GtkSourceGutterDataFunc": "callback",
		"GtkSourceGutterSizeFunc": "callback",
		"GtkSourceViewMarkTooltipFunc": "callback",
		"GtkTranslateFunc": "callback",
		"GtkTreeCellDataFunc": "callback",
		"GtkTreeDestroyCountFunc": "callback",
		"GtkTreeIterCompareFunc": "callback",
		"GtkTreeModelFilterModifyFunc": "callback",
		"GtkTreeModelFilterVisibleFunc": "callback",
		"GtkTreeModelForeachFunc": "callback",
		"GtkTreeSelectionForeachFunc": "callback",
		"GtkTreeSelectionFunc": "callback",
		"GtkTreeViewColumnDropFunc": "callback",
		"GtkTreeViewMappingFunc": "callback",
		"GtkTreeViewRowSeparatorFunc": "callback",
		"GtkTreeViewSearchPositionFunc": "callback",
		"PangoAttrFilterFunc": "callback",
		"PangoFontsetForeachFunc": "callback",
		"GtkTextBufferSerializeFunc": "callback",
		"char ***": "p",
		"const unsigned char **": "p",
		"GtkIconSize **": "p",
		"GtkClipboardGetFunc": "callback",
		"GtkClipboardClearFunc": "callback",
		"GtkRcPropertyParser": "callback",
		"GtkIconSet **": "p",
		"GdkAtom **": "p",
		"PangoAttrList **": "p",
		"GtkTreeViewColumn **": "p",
		"GtkClipboardRichTextReceivedFunc": "callback",
		"GtkWidget **": "p",
		"GdkScreen **": "p",
		"GtkKeySnoopFunc": "callback",
		"GtkClipboardTargetsReceivedFunc": "callback",
		"GtkMenuDetachFunc": "callback",
		"gchar ***": "p",
		"guint64": "uint64",
		"gint64": "int64",
		
		# Cairo
		"cairo_format_t": "enum",
		"cairo_fill_rule_t": "enum",
		"cairo_bool_t": "i",
		"cairo_status_t": "i", # FIXME
		"cairo_surface_t **": "p",
		"cairo_write_func_t": "callback",
		"cairo_line_join_t": "enum",
		"cairo_antialias_t": "enum",
		"cairo_hint_metrics_t": "enum",
		"cairo_text_cluster_t **": "p",
		"cairo_glyph_t **": "p",
		"cairo_text_cluster_flags_t": "flags",
		"cairo_font_type_t": "enum",
		"cairo_hint_style_t": "enum",
		"cairo_destroy_func_t": "callback",
		"cairo_user_scaled_font_unicode_to_glyph_func_t": "callback",
		"cairo_user_scaled_font_text_to_glyphs_func_t": "callback",
		"cairo_user_scaled_font_init_func_t": "callback",
		"cairo_filter_t": "enum",
		"cairo_pattern_type_t": "enum",
		"cairo_content_t": "flags",
		"cairo_surface_type_t": "enum",
		"cairo_subpixel_order_t": "enum",
		"cairo_extend_t": "enum",
		"cairo_font_slant_t": "enum",
		"cairo_font_weight_t": "enum",
		"cairo_line_cap_t": "enum",
		"cairo_region_overlap_t": "enum",
		"cairo_operator_t": "enum",		
		"cairo_user_scaled_font_render_glyph_func_t": "callback",
		"cairo_device_type_t": "enum",
		
		# Pango
		"PangoAlignment": "enum",
		"PangoAttrType": "enum",
		"PangoCoverageLevel": "enum",
		"PangoDirection": "enum",
		"PangoEllipsizeMode": "enum",
		"PangoGravity": "enum",
		"PangoGravityHint": "enum",
		"PangoRenderPart": "enum",
		"PangoScript": "enum",
		"PangoStretch": "enum",
		"PangoStyle": "enum",
		"PangoTabAlign": "enum",
		"PangoUnderline": "enum",
		"PangoVariant": "enum",
		"PangoWeight": "enum",
		"PangoWrapMode": "enum",
		"PangoFontMask": "flags",
		"PangoBidiType": "enum",
		"PangoLogAttr **": "p",
		"PangoFontDescription **": "p",
		"PangoFontFamily ***": "p",
		"int **": "p",
		"const char **": "p",
		"PangoGlyph": "guint32",
		"guchar **": "p",
		"gint **": "p",
		"PangoTabAlign **": "p",
		"char **": "p",
		"GSList **": "p",
		"PangoLanguage **": "p",
		"PangoFontFace ***": "p",
}
def getType(t):
	m = mapping.get(t)
	if m:
		while m and len(m) > 1:
			m = mapping.get(m)
	if m:
		return(m)
	else:
		if t.startswith("LP") or t.count("*") == 1:
			return("p")
		print >>sys.stderr, "warning: unknown: %s" % (t,)
		return "?"
auxes = parseAux("prototypes")

prefix = sys.argv[3]
def shorten(name):
	if name.startswith(prefix):
		return(name[len(prefix) : ])
	else:
		return(name)
symbols = map(lambda s: s.strip(), open(sys.argv[1], "r").readlines())
for name in symbols:
	aux = auxes.get(name)
	if aux is None:
		print >>sys.stderr, ("%s unknown" % name)
		#sys.exit(1)
	else:
		if aux.find("...") != -1: # ?!
			continue
		parts = aux.split("(")
		retname = parts[0].strip()
		i = retname.rfind(" ")
		assert(i != -1)
		name = retname[i + 1 : ].strip()
		ret = retname[ : i].strip()
		params = parts[1].rstrip()
		if params.endswith(");"):
			params = params[:-2].strip()
		shlib = sys.argv[2]
		result = ("let %s = (requireSharedLibrary \"%s\" 'P%s%s \"%s\") in " % (shorten(name), shlib, getType(ret), "".join(map(getType, params.split(", "))), name))
		if result.find("?") != -1:
			print >>sys.stderr, ("%s error in %s" % (name, result))
			sys.exit(1)
		print(result)

